{% if positions %}
<!-- Summary Stats -->
<div class="positions-summary">
    {% set total_pnl = positions | selectattr('pnl_usd', 'ne', None) | map(attribute='pnl_usd') | sum %}
    {% set long_count = positions | selectattr('direction', 'eq', 'BUY') | list | length %}
    {% set short_count = positions | selectattr('direction', 'eq', 'SELL') | list | length %}
    
    <div class="summary-item">
        <span class="summary-label">Totale Posizioni</span>
        <span class="summary-value">{{ positions | length }}</span>
    </div>
    <div class="summary-item">
        <span class="summary-label">Long / Short</span>
        <span class="summary-value">
            <span class="text-success">{{ long_count }}</span> / <span class="text-danger">{{ short_count }}</span>
        </span>
    </div>
    <div class="summary-item">
        <span class="summary-label">P&L Totale</span>
        <span class="summary-value {% if total_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ '{:+,.2f}'.format(total_pnl) }} $
        </span>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Simbolo</th>
                <th>Direzione</th>
                <th>Size</th>
                <th>Entry Price</th>
                <th>Mark Price</th>
                <th>P&L %</th>
                <th>Leva</th>
                <th>PnL (USD)</th>
                <th>Aggiornato</th>
            </tr>
        </thead>
        <tbody>
            {% for pos in positions %}
            <tr>
                <td><strong style="font-size: 0.85rem;">{{ pos.symbol }}</strong></td>
                <td>
                    {% if pos.direction %}
                    <span class="badge {% if pos.direction|upper == 'BUY' %}badge-long{% elif pos.direction|upper == 'SELL' %}badge-short{% endif %}">
                        {% if pos.direction|upper == 'BUY' %}â–² LONG{% else %}â–¼ SHORT{% endif %}
                    </span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td style="font-family: monospace;">{{ pos.size | format_decimal(4) }}</td>
                <td style="font-family: monospace;">
                    {% if pos.symbol == 'EUR/USD' %}
                    ${{ '%.5f' | format(pos.entry_price) if pos.entry_price else '-' }}
                    {% else %}
                    ${{ '%.2f' | format(pos.entry_price) if pos.entry_price else '-' }}
                    {% endif %}
                </td>
                <td style="font-family: monospace; font-weight: 600;">
                    {% if pos.symbol == 'EUR/USD' %}
                    ${{ '%.5f' | format(pos.mark_price) if pos.mark_price else '-' }}
                    {% else %}
                    ${{ '%.2f' | format(pos.mark_price) if pos.mark_price else '-' }}
                    {% endif %}
                </td>
                <td>
                    {% if pos.pnl_pct is not none %}
                    <span class="{% if pos.pnl_pct >= 0 %}text-success{% else %}text-danger{% endif %}" style="font-weight: 600;">
                        {{ '{:+.2f}'.format(pos.pnl_pct) }}%
                    </span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    <span class="leverage-badge">{{ pos.leverage or '1' }}x</span>
                </td>
                <td>
                    {% if pos.pnl_usd is not none %}
                    <span class="pnl-value {% if pos.pnl_usd >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ '{:+.2f}'.format(pos.pnl_usd) }} $
                    </span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="text-muted" style="font-size: 0.85rem;">{{ pos.last_update.strftime('%d/%m %H:%M') if pos.last_update else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
    .positions-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.25rem;
    }

    .summary-item {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .summary-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .summary-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #0f172a;
    }

    .table-container {
        overflow-x: auto;
        border-radius: 0.75rem;
        background: transparent;
    }

    .table-container table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
        font-size: 0.8rem;
    }

    .table-container thead {
        background: #f8fafc;
        color: #0f172a;
    }

    .table-container th {
        padding: 0.6rem 0.75rem;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
        letter-spacing: 0.04em;
        border-bottom: 1px solid #e2e8f0;
    }

    .table-container tbody {
        background: transparent !important;
    }

    .table-container tbody tr {
        background: #ffffff !important;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        transition: box-shadow 0.2s;
    }

    .table-container tbody tr:hover {
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }

    .table-container td {
        padding: 0.65rem 0.75rem;
        border-bottom: none;
        color: #1e293b !important;
        background-color: #ffffff !important;
        vertical-align: middle;
        font-size: 0.8rem;
    }

    .table-container tbody tr td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    .table-container tbody tr td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }

    .badge {
        display: inline-block;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .badge-long { color: #0f766e; }
    .badge-short { color: #b91c1c; }

    .leverage-badge {
        display: inline-block;
        color: #475569;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .pnl-value {
        font-weight: 700;
        font-size: 0.95rem;
    }

    .text-muted {
        color: #94a3b8 !important;
    }

    @media (max-width: 1024px) {
        .table-container table {
            font-size: 0.75rem;
        }
        .table-container th,
        .table-container td {
            padding: 0.5rem 0.4rem;
        }
    }
</style>

{% else %}
<div style="padding: 3rem; text-align: center; color: #64748b; background: #f8fafc; border-radius: 0.75rem; border: 1px solid #e2e8f0;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“­</div>
    <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Nessuna posizione aperta</p>
    <p style="font-size: 0.9rem;">Il bot non ha posizioni attive al momento.</p>
</div>
{% endif %}