{% if values and labels %}
<!-- Quick Stats Above Chart -->
<div class="balance-stats">
    <div class="stat-item">
        <span class="stat-label">Valore Attuale</span>
        <span class="stat-value">${{ '{:,.2f}'.format(values[-1]) }}</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Valore Iniziale</span>
        <span class="stat-value">${{ '{:,.2f}'.format(values[0]) }}</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Variazione</span>
        {% set change = values[-1] - values[0] %}
        {% set change_pct = ((values[-1] - values[0]) / values[0] * 100) if values[0] > 0 else 0 %}
        <span class="stat-value {% if change >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ '{:+,.2f}'.format(change) }} USD ({{ '{:+.2f}'.format(change_pct) }}%)
        </span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Massimo Raggiunto</span>
        <span class="stat-value">${{ '{:,.2f}'.format(values | max) }}</span>
    </div>
</div>

<div style="height: 400px; padding: 0.5rem 0.25rem 0.75rem 0;">
    <canvas id="balanceChart" style="display:block; width:100%;"></canvas>
</div>

<script>
    (function () {
        const canvas = document.getElementById('balanceChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        const labels = {{ labels | tojson }};
        const data = {{ values | tojson }};
        const maxValue = Math.max(...data);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Saldo USD',
                        data: data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2.5,
                        pointRadius: 0,
                        tension: 0.3,
                        fill: true,
                    },
                    {
                        label: 'Valore iniziale',
                        data: Array(data.length).fill(data.length ? data[0] : null),
                        borderColor: '#9ca3af',
                        borderDash: [5, 4],
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0,
                    },
                    {
                        label: 'Massimo storico',
                        data: Array(data.length).fill(maxValue),
                        borderColor: '#10b981',
                        borderDash: [3, 3],
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 0,
                        right: 10,
                        top: 10,
                        bottom: 0,
                    },
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#374151',
                            font: { size: 11, weight: '500' },
                            padding: 15,
                            usePointStyle: true,
                        },
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        padding: 12,
                        titleColor: '#f1f5f9',
                        bodyColor: '#e2e8f0',
                        borderColor: '#334155',
                        borderWidth: 1,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                const raw = labels[context[0].dataIndex];
                                const d = new Date(raw);
                                return d.toLocaleString('it-IT', {
                                    day: '2-digit',
                                    month: 'short',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                });
                            },
                            label: function (context) {
                                const value = context.parsed.y;
                                if (context.datasetIndex === 0) {
                                    const initial = data[0];
                                    const change = value - initial;
                                    const changePct = ((change / initial) * 100).toFixed(2);
                                    return 'Saldo: $' + value.toFixed(2) + ' (' + (change >= 0 ? '+' : '') + changePct + '%)';
                                }
                                return context.dataset.label + ': $' + value.toFixed(2);
                            },
                        },
                    },
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#64748b',
                            maxTicksLimit: 8,
                            font: { size: 10 },
                            callback: function (value, index, ticks) {
                                const raw = labels[index];
                                const d = new Date(raw);
                                if (isNaN(d.getTime())) return raw;
                                return d.toLocaleString('it-IT', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                });
                            },
                        },
                        grid: { 
                            display: false,
                        },
                    },
                    y: {
                        ticks: {
                            color: '#64748b',
                            font: { size: 10 },
                            callback: function (value) {
                                return '$' + value.toLocaleString('en-US', {maximumFractionDigits: 0});
                            },
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.2)',
                            lineWidth: 1,
                        },
                    },
                },
            },
        });
    })();
</script>

<style>
    .balance-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #0f172a;
    }
</style>

{% else %}
<div style="text-align: center; padding: 3rem; color: #64748b;">
    <p style="font-size: 1.1rem;">ðŸ“Š Nessun dato di saldo trovato.</p>
    <p style="font-size: 0.9rem; margin-top: 0.5rem;">Il trading system non ha ancora registrato dati nel database.</p>
</div>
{% endif %}
